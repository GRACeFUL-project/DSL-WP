\documentclass{article}
\usepackage{todonotes}
\usepackage[T1]{fontenc}
\usepackage{lmodern}
\usepackage{amssymb,amsmath}
\usepackage{ifxetex,ifluatex}
\usepackage{fixltx2e} % provides \textsubscript
\usepackage[utf8]{inputenc}
\usepackage{color}
\usepackage[unicode=true]{hyperref}
\hypersetup{breaklinks=true,
            bookmarks=true,
            pdfauthor={Patrik Jansson et al.},
            pdftitle={GRACeFUL D4.3: Translation of GRACeFUL concept maps to the Constraint Functional Programming layer},
            colorlinks=true,
            citecolor=blue,
            urlcolor=blue,
            linkcolor=magenta,
            pdfborder={0 0 0}}
\urlstyle{same}  % don't use monospace font for urls
\setlength{\parindent}{0pt}
\setlength{\parskip}{4pt plus 2pt minus 1pt}
\setlength{\emergencystretch}{3em}  % prevent overfull lines

%% Cezar
\usepackage[margin=1.60in]{geometry}
\usepackage[verbose]{wrapfig}
\usepackage{graphicx}
\usepackage{subfig}
\usepackage{rotating}
\usepackage{lscape}
\usepackage{float}
\usepackage{geometry}
\usepackage{framed}
\usepackage{xspace}
\usepackage{acronym}
\usepackage[square,numbers]{natbib}

%% Max
\usepackage{minted}
\usepackage{todonotes}

\definecolor{GRACeFULblue}{rgb}{0.20,0.60,0.86}

\newcommand{\grace}{GRACeFUL\xspace}
\acrodef{GCM}{\grace Concept Map}
\acrodef{GMB}{Group Model Building}
\acrodef{DSL}{Domain Specific Language}
\acrodef{CFP}{Constraint Functional Program}
\acrodef{RAT}{Rapid Assessment Tool}
\acrodef{CRUD}{Climate Resilient Urban Design}
\acrodef{CLD}{Causal Loop Diagram}
\acrodef{JSON}{JavaScript Object Notation}
\acrodef{CP}{Constraint Program}
\hyphenation{GRACeFUL}

\author{}
\date{}

\begin{document}

\begin{center}
\includegraphics[width=5cm]{../coverpage/GRACeFULlogo.png}

\textcolor{GRACeFULblue}{Global systems Rapid Assessment tools\\
through Constraint FUnctional Languages}

\vspace{1cm}

FETPROACT-1-2014 Grant Nº 640954

\end{center}

\begin{framed}
\begin{center}
\Large
Translation of GRACeFUL concept maps\\
to the Constraint Functional Programming layer\\[1ex]

D4.3\\[1ex]

\end{center}
\end{framed}

\vspace{1cm}

\noindent
\begin{tabular}{@{}ll@{}}
  Lead Participant:       & Chalmers (WP leader: P. Jansson)
\\Partners Contributing:  & KU Leuven
\\Dissemination Level:    & PU
\\Document Version:       & Draft
\\Date of Submission:     & 2017-07-07?
\\Due Date of Delivery:   & 2017-07-31
\end{tabular}

\newpage

\section*{Translation of GRACeFUL concept maps to the Constraint Functional Programming layer}\label{DSL4GRACeFUL}

Contributions by: Oskar Abrahamsson, Maximilian Algehed, Sólrún
Einarsdóttir, Alex Gerdes, and Patrik Jansson.

\vfill

\setcounter{tocdepth}{2}
\tableofcontents

\vfill

\newpage

\section*{Abstract}\label{abstract}

This third deliverable (D4.3) of work package 4 presents the
translation of GRACeFUL concept maps (expressed as GRACe programs) to
the Constraint Functional Programming (CFP) layer.
%
This report builds on the description of GRACe in ``D4.2: A Domain
Specific Language (DSL) for GRACeFUL Concept Maps'' (delivered in
project month 24) and the third release of the CFP layer ``haskelzinc''.
%
(The first release was described in ``D5.1: Domain-Specific Language
for the Constraint Functional Programming Platform'' and the latest
version is available from the Haskell package repository
\href{https://hackage.haskell.org/package/haskelzinc}{Hackage}.)
%
The work leading up to this deliverable is within Task 4.3 ``implement
a middleware for connecting the DSL to the CFP layer'' and the full
source code of the implementation is available on github.


\section{Introduction}

This report describes the third deliverable (D4.3) of work package 4 of the
\grace project. The software we present in this document can be downloaded
from GitHub\footnote{\url{https://github.com/GRACeFUL-project/}}.

The main task of work package 4 is to build a \emph{\ac{DSL}} for \acp{GCM}. A
\ac{GCM} is a representation of policy analysis that contains the main elements
of a policy problem definition, such as goals, criteria, and a description of
the system. It is common practice to simulate a model described by a \ac{GCM},
however, this process is unfortunately both time consuming and expensive. The
\grace project tries to aleviate this problem by expressing a \ac{GCM} as a
\emph{constraint program}, which should reduce the analysis time considerably.

A \ac{GCM} is created by stakeholders in a so-called \ac{GMB} session using a
visual editor. Once the \ac{GCM} is complete, the visual editor submits a
representation\footnote{We use \ac{JSON} as an exchange format} of the \ac{GCM}
to our \ac{DSL} layer, described in deliverable D4.2~\cite{D4.2}, which in turn
passes on the \ac{GCM} to the \ac{CP} layer. The \ac{DSL} can be regarded as an
intermediate layer between the visual editor and the \ac{CP} layer, which
increases modularity and reduces the depency on a particular constraint solver. 

The main challenge for work package 4 is to create a \ac{DSL} that is expressive
enough to model \acp{GCM} as envisaged by the stakeholders, while still being
able to translate to a contraint program. A constraint program is a
collection of (unknown) variables and constraints, for which a constraint solver
tries to find a solution (values for the unknown variables) that satisfies as
many of those constraints as possible. 

In this document we explain how we translate a program in terms of our \ac{DSL} 
to a constraint program using the \ac{CP} interface provided by work pacakge 5, 
see deliverable~\cite{}. In Section~\ref{sec:translate} give a short summary
of our \ac{DSL} and show how the main concepts, such as pports and parameters,
are expressed in terms of a constraint program. We continue with an explanation
of the software architecture in Section~\ref{sec:architecture}. We end this 
report with some concluding remarks in Section~\ref{sec:conclusion}.


\section{A GRACe-ful translation}
\label{sec:translate}

This section covers how a model written in our DSL, called GRACe, is translated
to a constraint program. This translation is done in several stages. First we
translate a GRACe program to HaskellZinc~\cite{}, which is developed in work
package 5. In the next stage the program is compiled from the HaskellZinc
interemediate representation to a particular constraint programming language,
which in our case is MiniZinc~\cite{MiniZinc}.

WWe start with a small example to explain the syntax and elements of a GRACe
program. A central element of a GRACe program is a \emph{component}, in fact a
GRACe program is a collection of components that can be connected to each other.
The following example defines two components:

\begin{minted}[linenos]{haskell}
  example :: GCM ()
  example = do
    a <- createPort
    b <- createPort

    component $ do
      av <- value a
      bv <- value b
      assert $ av === bv + 1

    output "a" a
    output "b" b
\end{minted}

of both GRACe and
MiniZinc. The |example| component has two ports, |a| and |b|, whose values are
constrained (on line 8) to stay one apart. The last two lines decide what we
want to see as results from the constraint solver.

When we run the GRACe translator we get the following MiniZinc code:
%
\begin{verbatim}
  var -10000000..10000000: v1;
  var -10000000..10000000: v0;

  constraint ((v0) == ((v1) + (1)));

  solve satisfy;
  output ["{\"a\" : \(v0),\n\"b\" : \(v1)}"];
\end{verbatim}
%
From the output statement on the last line we can see that \texttt{a} has
been mapped to \texttt{v0} and \texttt{b} to \texttt{v1}.
%
In the middle we see the constraint and in the beginning the
variables' ranges are defined.
%
(TODO: The default range can be adjusted by ...)

\todo{Max?: More complex example (connecting 2-3 components) showing parts of the output.}


\section{Software architecture}
\label{sec:architecture}

\input{architecture}


\section{Properties and tests}

As a first step towards a testing and verification framework for
GRACeFUL Rapid Assessment Tools we have instrumented the GRACe
implementation with properties and tests.
%

\todo{explain QuickCheck, Fill in properties and tests, next steps}

\section{Conclusion}
\label{sec:conclusion}

We have designed and implemented a translation from the DSL called
GRACe (describing GRACeFUL concept maps) to the underlying Constraint
Functional Programming layer.
%
We have presented code examples, the software architecture, and
automatically checked properties of the translation.
%
The source code is available on GitHub.

The next actions in work package 4 is
\begin{itemize}
\item build a testing and verification framework for RATs,
\item assist WP3 in implementing the graphical user interface, and
\item assist WP2 in building up a library of GRACeFUL Concept Map
  components expressed in GRACe.
\end{itemize}
%
In parallel, the translation, including the source and target DSLs
will gradually evolve to handle more and more of the requirements
extractable from GMB sessions with stakeholders.

% ----------------------------------------------------------------
\appendix

\input{install}
% ----------------------------------------------------------------

\bibliographystyle{unsrtnat}
\bibliography{d4.3}

\end{document}
